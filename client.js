// Generated by CoffeeScript 1.3.3
var countDuration, countStart, cumsum, currentQuestion, generateName, identifier, interpolateQuestion, lastTime, publicname, revealDelay, serverTime, socket, stateUpdater, sync_offset, synchronize, timeFreeze, timeSync;

socket = io.connect().of(channel_name);

sync_offset = 0;

currentQuestion = null;

lastTime = null;

revealDelay = null;

timeFreeze = false;

identifier = Math.random().toString(36).slice(3);

generateName = function() {
  var adjective, animal, pick;
  adjective = 'aberrant,agressive,warty,hoary,breezy,dapper,edgy,feisty,gutsy,hardy,intrepid,jaunty,karmic,lucid,maverick,natty,oneric,precise,quantal';
  animal = 'axolotl,warthog,hedgehog,badger,drake,fawn,gibbon,heron,ibex,jackalope,koala,lynx,meerkat,narwhal,ocelot,penguin,quetzal,kodiak,cheetah,puma,jaguar,panther,tiger,leopard,lion';
  pick = function(list) {
    var n;
    n = list.split(',');
    return n[Math.floor(n.length * Math.random())];
  };
  return pick(adjective) + " " + pick(animal);
};

publicname = generateName();

serverTime = function() {
  if (timeFreeze) {
    return timeFreeze;
  } else {
    return +(new Date) - sync_offset;
  }
};

cumsum = function(list, rate) {
  var num, sum, _i, _len, _results;
  sum = 0;
  _results = [];
  for (_i = 0, _len = list.length; _i < _len; _i++) {
    num = list[_i];
    _results.push(sum += Math.round(num) * rate);
  }
  return _results;
};

interpolateQuestion = function(question, time) {};

countDuration = 0;

countStart = 0;

stateUpdater = function() {
  var countdown, cumulative, endTimes, index, list, ms, rate, reveal, timeDelta, words, _ref;
  if (currentQuestion) {
    timeDelta = serverTime() - lastTime;
    words = currentQuestion.question.split(" ");
    _ref = currentQuestion.timing, list = _ref.list, rate = _ref.rate;
    cumulative = cumsum(list, rate);
    index = 0;
    while (timeDelta > cumulative[index]) {
      index++;
    }
    index++;
    endTimes = cumulative[cumulative.length - 1];
    reveal = endTimes + revealDelay + lastTime - serverTime();
    if (reveal < 0) {
      document.querySelector('#answer').innerText = currentQuestion.answer;
      document.querySelector('#answer').style.display = '';
    } else {
      document.querySelector('#answer').style.display = 'none';
    }
    reveal = Math.max(0, reveal);
    document.querySelector('#reveal').innerText = (reveal / 1000).toFixed(1);
    document.querySelector("#visible").innerText = words.slice(0, index).join(' ') + " ";
    document.querySelector("#unread").innerText = words.slice(index).join(' ');
  }
  ms = Math.max(0, countDuration - (new Date - countStart));
  countdown = (ms / 1000).toFixed(1);
  if (countDuration > 0) {
    document.querySelector('#countdown').style.display = '';
    return document.querySelector('#countdown').innerText = countdown;
  } else {
    return document.querySelector('#countdown').style.display = 'none';
  }
};

setInterval(stateUpdater, 50);

synchronize = function(data) {
  console.log("sync", data);
  if (data.question) {
    currentQuestion = data.question;
  }
  sync_offset = +(new Date) - data.time;
  countDuration = data.countDuration;
  countStart = +(new Date);
  lastTime = data.lastTime;
  revealDelay = data.revealDelay;
  return timeFreeze = data.timeFreeze;
};

timeSync = function() {};

socket.on('sync', synchronize);

socket.on('buzz', function(data) {
  stateUpdater();
  return console.log("froze time!");
});

document.addEventListener('keydown', function(e) {
  if (e.keyCode === 13) {
    socket.emit('buzz', {
      name: publicname,
      id: identifier
    }, function(status) {
      return console.log("current state", status);
    });
    return console.log("pressed enter");
  } else if (e.keyCode === 90) {
    return socket.emit('unbuzz', "because the universe makes no sense", function(status) {
      return console.log("unbuzz permissions", status);
    });
  }
});

synchronize(initial_sync);
