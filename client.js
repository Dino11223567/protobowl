// Generated by CoffeeScript 1.3.3
var addAnnotation, avg, changeQuestion, chatAnnotation, createBundle, cumsum, generateName, is_touch, last_question, latency_log, public_name, renderPartial, renderState, renderTimer, sock, sync, sync_offset, sync_offsets, testLatency, time, userSpan, users,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

sock = io.connect();

sync = {};

users = {};

sync_offsets = [];

sync_offset = 0;

is_touch = !!(__indexOf.call(window, 'ontouchstart') >= 0);

$('html').toggleClass('touchscreen', is_touch);

generateName = function() {
  var adjective, animal, pick;
  adjective = 'flaming,aberrant,agressive,warty,hoary,breezy,dapper,edgy,feisty,gutsy,hardy,intrepid,jaunty,karmic,lucid,maverick,natty,oneric,precise,quantal,quizzical,curious,derisive,bodacious,nefarious';
  animal = 'monkey,axolotl,warthog,hedgehog,badger,drake,fawn,gibbon,heron,ibex,jackalope,koala,lynx,meerkat,narwhal,ocelot,penguin,quetzal,kodiak,cheetah,puma,jaguar,panther,tiger,leopard,lion,neandertal';
  pick = function(list) {
    var n;
    n = list.split(',');
    return n[Math.floor(n.length * Math.random())];
  };
  return pick(adjective) + " " + pick(animal);
};

public_name = generateName();

$('#username').val(public_name);

$('#username').keydown(function(e) {
  return e.stopPropagation();
});

$('#username').keyup(function() {
  console.log('renaming');
  return sock.emit('rename', $(this).val());
});

avg = function(list) {
  var item, sum, _i, _len;
  sum = 0;
  for (_i = 0, _len = list.length; _i < _len; _i++) {
    item = list[_i];
    sum += item;
  }
  return sum / list.length;
};

cumsum = function(list, rate) {
  var num, sum, _i, _len, _results;
  sum = 0;
  _results = [];
  for (_i = 0, _len = list.length; _i < _len; _i++) {
    num = list[_i];
    _results.push(sum += Math.round(num) * rate);
  }
  return _results;
};

time = function() {
  if (sync.time_freeze) {
    return sync.time_freeze;
  } else {
    return new Date - sync_offset - sync.time_offset;
  }
};

window.onbeforeunload = function() {
  localStorage.old_socket = sock.socket.sessionid;
  return null;
};

sock.on('echo', function(data, fn) {
  return fn('alive');
});

sock.on('disconnect', function() {
  return setTimeout(function() {
    return $('#disco').modal('show');
  }, 1000);
});

sock.once('connect', function() {
  return sock.emit('join', {
    old_socket: localStorage.old_socket,
    room_name: channel_name,
    public_name: public_name
  });
});

sock.on('sync', function(data) {
  var attr, below, item, thresh;
  sync_offsets.push(+(new Date) - data.real_time);
  thresh = avg(sync_offsets);
  below = (function() {
    var _i, _len, _results;
    _results = [];
    for (_i = 0, _len = sync_offsets.length; _i < _len; _i++) {
      item = sync_offsets[_i];
      if (item <= thresh) {
        _results.push(item);
      }
    }
    return _results;
  })();
  sync_offset = avg(below);
  $('#sync_offset').text(sync_offset.toFixed(1) + '/' + thresh.toFixed(1));
  console.log('sync', data);
  for (attr in data) {
    sync[attr] = data[attr];
  }
  return renderState();
});

latency_log = [];

testLatency = function() {
  var initialTime;
  initialTime = +(new Date);
  return sock.emit('echo', {}, function(firstServerTime) {
    var recieveTime;
    recieveTime = +(new Date);
    return sock.emit('echo', {}, function(secondServerTime) {
      var CSC1, CSC2, SCS1, secondTime;
      secondTime = +(new Date);
      CSC1 = recieveTime - initialTime;
      CSC2 = secondTime - recieveTime;
      SCS1 = secondServerTime - firstServerTime;
      latency_log.push(CSC1);
      latency_log.push(SCS1);
      return latency_log.push(CSC2);
    });
  });
};

setTimeout(function() {
  testLatency();
  return setInterval(testLatency, 60 * 1000);
}, 2500);

last_question = null;

sock.on('chat', function(data) {
  return chatAnnotation(data);
});

renderState = function() {
  var action, count, list, row, user, votes, _i, _j, _len, _len1, _ref, _ref1, _ref2;
  if (sync.users) {
    _ref = sync.users;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      user = _ref[_i];
      votes = [];
      for (action in sync.voting) {
        if (_ref1 = user.id, __indexOf.call(sync.voting[action], _ref1) >= 0) {
          votes.push(action);
        }
      }
      user.votes = votes.join(', ');
      users[user.id] = user;
    }
    list = $('.leaderboard tbody');
    count = 0;
    list.find('tr').addClass('to_remove');
    _ref2 = sync.users;
    for (_j = 0, _len1 = _ref2.length; _j < _len1; _j++) {
      user = _ref2[_j];
      $('.user-' + user.id).text(user.name);
      count++;
      row = list.find('.sockid-' + user.id);
      if (row.length < 1) {
        console.log('recreating user');
        row = $('<tr>').appendTo(list);
        row.popover({
          placement: function() {
            if (matchMedia('(max-width: 768px)').matches) {
              return "top";
            } else {
              return "left";
            }
          },
          title: user.name + "'s stats",
          trigger: 'manual',
          content: 'well, they dont exist. sorry. ' + user.id
        });
        row.click(function() {
          $('.leaderboard tbody tr').not(this).popover('hide');
          return $(this).popover('toggle');
        });
      }
      row.find('td').remove();
      row.addClass('sockid-' + user.id);
      row.removeClass('to_remove');
      $('<td>').text(count).appendTo(row);
      $('<td>').text(user.name).appendTo(row);
      $('<td>').text(user.votes || 0).appendTo(row);
      $('<td>').text(7).appendTo(row);
    }
    list.find('tr.to_remove').remove();
  }
  return renderPartial();
};

renderPartial = function() {
  var bundle, change, cumulative, index, list, new_text, node, old_text, progress, rate, timeDelta, words, _ref;
  if (!(sync.question && sync.timing)) {
    return;
  }
  if (sync.question !== last_question) {
    changeQuestion();
    last_question = sync.question;
  }
  timeDelta = time() - sync.begin_time;
  words = sync.question.split(' ');
  _ref = sync.timing, list = _ref.list, rate = _ref.rate;
  cumulative = cumsum(list, rate);
  index = 0;
  while (timeDelta > cumulative[index]) {
    index++;
  }
  if (timeDelta > cumulative[0] / 2) {
    index++;
  }
  bundle = $('#history .bundle').first();
  new_text = words.slice(0, index).join(' ');
  old_text = bundle.find('.readout .visible').text();
  if (new_text !== old_text) {
    if (new_text.indexOf(old_text === 0)) {
      node = bundle.find('.readout .visible')[0];
      change = new_text.slice(old_text.length);
      node.appendChild(document.createTextNode(change));
    } else {
      bundle.find('.readout .visible').text(new_text);
    }
    bundle.find('.readout .unread').text(words.slice(index).join(' '));
  }
  renderTimer(sync.end_time - time());
  progress = (time() - sync.begin_time) / (sync.end_time - sync.begin_time);
  $('.progress .bar').width(progress * 100 + '%');
  if (latency_log.length > 0) {
    return $('#latency').text(avg(latency_log).toFixed(1));
  }
};

setInterval(renderState, 10000);

setInterval(renderPartial, 50);

renderTimer = function(ms) {
  var cs, min, pad, sec, sign;
  if (sync.time_freeze) {
    $('#pause').fadeIn();
  } else {
    $('#pause').fadeOut();
  }
  $('.progress').toggleClass('progress-warning', !!sync.time_freeze);
  sign = "";
  if (ms < 0) {
    sign = "+";
  }
  sec = Math.abs(ms) / 1000;
  cs = (sec % 1).toFixed(1).slice(1);
  $('.timer .fraction').text(cs);
  min = sec / 60;
  pad = function(num) {
    var str;
    str = Math.floor(num).toString();
    while (str.length < 2) {
      str = '0' + str;
    }
    return str;
  };
  return $('.timer .face').text(sign + pad(min) + ':' + pad(sec % 60));
};

changeQuestion = function() {
  var bundle, cutoff, old;
  cutoff = 10;
  if (matchMedia('(max-width: 768px)').matches) {
    cutoff = 1;
  }
  $('.bundle').slice(cutoff).slideUp('normal', function() {
    return $(this).remove();
  });
  old = $('#history .bundle').first();
  old.removeClass('active');
  if (old.find('.readout').length > 0) {
    old.find('.readout')[0].normalize();
  }
  old.find('.readout').slideUp('slow');
  bundle = createBundle().width($('#history').width());
  bundle.addClass('active');
  $('#history').prepend(bundle.hide());
  bundle.slideDown('slow');
  return bundle.width('auto');
};

createBundle = function() {
  var addInfo, annotations, breadcrumb, readout, well;
  breadcrumb = $('<ul>').addClass('breadcrumb');
  addInfo = function(name, value) {
    breadcrumb.find('li').last().append($('<span>').addClass('divider').text('/'));
    return breadcrumb.append($('<li>').text(name + ": " + value));
  };
  addInfo('Category', sync.info.category);
  addInfo('Difficulty', sync.info.difficulty);
  addInfo('Tournament', sync.info.tournament);
  addInfo('Year', sync.info.year);
  breadcrumb.append($('<li>').addClass('answer pull-right').text("Answer: " + sync.answer));
  readout = $('<div>').addClass('readout');
  well = $('<div>').addClass('well').appendTo(readout);
  well.append($('<span>').addClass('visible'));
  well.append(document.createTextNode(' '));
  well.append($('<span>').addClass('unread').text(sync.question));
  annotations = $('<div>').addClass('annotations');
  return $('<div>').addClass('bundle').append(breadcrumb).append(readout).append(annotations);
};

userSpan = function(user) {
  return $('<span>').addClass('user-' + user).text(users[user].name);
};

addAnnotation = function(el) {
  el.css('display', 'none').prependTo($('#history .bundle .annotations').first());
  el.slideDown();
  return el;
};

chatAnnotation = function(_arg) {
  var final, id, line, session, text, user;
  session = _arg.session, text = _arg.text, user = _arg.user, final = _arg.final;
  id = user + '-' + session;
  if ($('#' + id).length > 0) {
    line = $('#' + id);
  } else {
    line = $('<p>').attr('id', id);
    line.append(userSpan(user).addClass('author'));
    line.append(document.createTextNode(' '));
    $('<span>').addClass('comment').appendTo(line);
    addAnnotation(line);
  }
  line.find('.comment').text(text);
  return line.toggleClass('typing', !final);
};

sock.on('introduce', function(_arg) {
  var line, user;
  user = _arg.user;
  line = $('<p>').addClass('log');
  line.append(userSpan(user));
  line.append(" joined the room");
  return addAnnotation(line);
});

sock.on('leave', function(_arg) {
  var line, user;
  user = _arg.user;
  line = $('<p>').addClass('log');
  line.append(userSpan(user));
  line.append(" left the room");
  return addAnnotation(line);
});

jQuery('.bundle .breadcrumb').live('click', function() {
  if (!$(this).is(jQuery('.bundle .breadcrumb').first())) {
    return $(this).parent().find('.readout').slideToggle();
  }
});

$('.main_input').keydown(function(e) {
  return e.stopPropagation();
});

$('.main_input').keyup(function(e) {
  var mode, val;
  mode = $('.main_input').data('mode');
  if (mode === 'buzz') {
    if (e.keyCode === 13) {
      sock.emit('guess', {
        text: $(this).val(),
        final: true
      });
      $('.main_input').attr('disabled', true).val('').blur();
      return $('.main_input').data('mode', '');
    } else {
      return sock.emit('guess', {
        text: $(this).val()
      });
    }
  } else if (mode === 'chat') {
    val = $(this).val().replace(/^.*?: ?/g, '');
    if (e.keyCode === 13) {
      sock.emit('chat', {
        text: val,
        final: true,
        session: $(this).data('input_session')
      });
      $('.main_input').attr('disabled', true).val('').blur();
      return $('.main_input').data('mode', '');
    } else {
      return sock.emit('chat', {
        text: val,
        session: $(this).data('input_session')
      });
    }
  }
});

$('body').keydown(function(e) {
  var mode, _ref;
  mode = $('.main_input').data('mode');
  if (mode === 'chat') {
    $('.main_input').focus();
    return;
  }
  if (e.keyCode === 32) {
    sock.emit('buzz', 'MARP', function(result) {
      console.log(result);
      $('.main_input').data('mode', 'buzz');
      return $('.main_input').attr('disabled', false).focus();
    });
    return e.preventDefault();
  } else if (e.keyCode === 83) {
    return sock.emit('skip', 'yay');
  } else if (e.keyCode === 80) {
    return sock.emit('pause', 'yay');
  } else if (e.keyCode === 90) {
    return sock.emit('unpause', 'yay');
  } else if ((_ref = e.keyCode) === 47 || _ref === 111 || _ref === 191) {
    console.log("slash");
    e.preventDefault();
    $('.main_input').data('mode', 'chat');
    $('.main_input').data('input_session', Math.random().toString(36).slice(3));
    return $('.main_input').attr('disabled', false).val('chat: ').focus();
  }
});
